<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE 2026 Interactive Preparation Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- IMPORTANT GLOBAL VARIABLES ---
        // These are provided by the environment and should not be changed.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --- END OF GLOBAL VARIABLES ---

        const statusConfig = {
            "Not Started": { color: 'bg-gray-400', text: 'text-gray-500' },
            "In Progress": { color: 'bg-blue-500', text: 'text-blue-600' },
            "Completed": { color: 'bg-indigo-500', text: 'text-indigo-600' },
            "Revised": { color: 'bg-purple-500', text: 'text-purple-600' },
            "Mastered": { color: 'bg-green-500', text: 'text-green-600' },
        };

        let progressChart;
        let currentFilter = 'All';
        let trackerData = [];
        let userId = null;
        let db;
        let isLoading = true;

        const defaultSyllabusData = [
            { id: 1, type: 'subject', name: 'General Aptitude', children: [2, 6, 10, 14, 18] },
            { id: 2, type: 'topic', name: 'Verbal Aptitude', parent: 1, children: [3, 4, 5] },
            { id: 3, type: 'subtopic', parent: 2, name: 'Grammar and Vocabulary', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 4, type: 'subtopic', parent: 2, name: 'Reading and Comprehension', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 5, type: 'subtopic', parent: 2, name: 'Narrative Sequencing', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 6, type: 'topic', name: 'Quantitative Aptitude', parent: 1, children: [7, 8, 9] },
            { id: 7, type: 'subtopic', parent: 6, name: 'Data Interpretation and Analysis', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 8, type: 'subtopic', parent: 6, name: 'Mensuration, Geometry, Trigonometry', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 9, type: 'subtopic', parent: 6, name: 'Probability, Permutations & Combinations', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 10, type: 'topic', name: 'Analytical Aptitude', parent: 1, children: [11, 12, 13] },
            { id: 11, type: 'subtopic', parent: 10, name: 'Logic and Deduction', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 12, type: 'subtopic', parent: 10, name: 'Induction and Analogy', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 13, type: 'subtopic', parent: 10, name: 'Coding & Decoding', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 14, type: 'topic', name: 'Spatial Aptitude', parent: 1, children: [15, 16, 17] },
            { id: 15, type: 'subtopic', parent: 14, name: 'Paper folding, Cutting, and 3D diagrams', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 16, type: 'subtopic', parent: 14, name: 'Visualizing solid objects', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 17, type: 'subtopic', parent: 14, name: 'Grouping of images', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 18, type: 'topic', name: 'Engineering Mathematics', parent: 1, children: [19, 23, 27, 31] },
            { id: 19, type: 'topic', name: 'Discrete Mathematics', parent: 18, children: [20, 21, 22] },
            { id: 20, type: 'subtopic', parent: 19, name: 'Logic, Set Theory & Relations', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 21, type: 'subtopic', parent: 19, name: 'Combinatorics', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 22, type: 'subtopic', parent: 19, name: 'Graph Theory', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 23, type: 'topic', name: 'Linear Algebra', parent: 18, children: [24, 25, 26] },
            { id: 24, type: 'subtopic', parent: 23, name: 'Matrices, Determinants & Vector spaces', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 25, type: 'subtopic', parent: 23, name: 'Eigenvalues & Eigenvectors', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 26, type: 'subtopic', parent: 23, name: 'Systems of linear equations', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 27, type: 'topic', name: 'Calculus', parent: 18, children: [28, 29, 30] },
            { id: 28, type: 'subtopic', parent: 27, name: 'Limits, Continuity & Differentiability', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 29, type: 'subtopic', parent: 27, name: 'Integral Calculus', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 30, type: 'subtopic', parent: 27, name: 'Differential Equations', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 31, type: 'topic', name: 'Probability & Statistics', parent: 18, children: [32, 33, 34] },
            { id: 32, type: 'subtopic', parent: 31, name: 'Probability & Random Variables', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 33, type: 'subtopic', parent: 31, name: 'Distributions', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 34, type: 'subtopic', parent: 31, name: 'Covariance & Correlation', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 35, type: 'subject', name: 'Computer Science and Information Technology (CS)', children: [36, 40, 44, 48, 52, 56, 60, 64, 68] },
            { id: 36, type: 'topic', name: 'Digital Logic', parent: 35, children: [37, 38, 39] },
            { id: 37, type: 'subtopic', parent: 36, name: 'Boolean algebra', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 38, type: 'subtopic', parent: 36, name: 'Combinational circuits', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 39, type: 'subtopic', parent: 36, name: 'Sequential circuits', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 40, type: 'topic', name: 'Computer Organization & Architecture', parent: 35, children: [41, 42, 43] },
            { id: 41, type: 'subtopic', parent: 40, name: 'Machine instructions & Addressing modes', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 42, type: 'subtopic', parent: 40, name: 'CPU control, I/O Interfacing & Pipelining', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 43, type: 'subtopic', parent: 40, name: 'Memory hierarchy', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 44, type: 'topic', name: 'Programming & Data Structures', parent: 35, children: [45, 46, 47] },
            { id: 45, type: 'subtopic', parent: 44, name: 'Recursion, Stacks, Queues, Linked Lists', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 46, type: 'subtopic', parent: 44, name: 'Trees, Heaps, Binary Search Trees', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 47, type: 'subtopic', parent: 44, name: 'Graphs', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 48, type: 'topic', name: 'Algorithms', parent: 35, children: [49, 50, 51] },
            { id: 49, type: 'subtopic', parent: 48, name: 'Asymptotic analysis, Sorting & Searching', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 50, type: 'subtopic', parent: 48, name: 'Algorithm design techniques', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 51, type: 'subtopic', parent: 48, name: 'Graph algorithms', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 52, type: 'topic', name: 'Theory of Computation', parent: 35, children: [53, 54, 55] },
            { id: 53, type: 'subtopic', parent: 52, name: 'Regular expressions, Finite automata', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 54, type: 'subtopic', parent: 52, name: 'Context-Free Languages, Pushdown automata', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 55, type: 'subtopic', parent: 52, name: 'Turing machines, Undecidability', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 56, type: 'topic', name: 'Compiler Design', parent: 35, children: [57, 58, 59] },
            { id: 57, type: 'subtopic', parent: 56, name: 'Lexical analysis & Parsing', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 58, type: 'subtopic', parent: 56, name: 'Syntax Directed Translation', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 59, type: 'subtopic', parent: 56, name: 'Code Generation & Optimization', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 60, type: 'topic', name: 'Operating System', parent: 35, children: [61, 62, 63] },
            { id: 61, type: 'subtopic', parent: 60, name: 'Processes, Threads, Scheduling', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 62, type: 'subtopic', parent: 60, name: 'Memory management', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 63, type: 'subtopic', parent: 60, name: 'File systems', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 64, type: 'topic', name: 'Databases', parent: 35, children: [65, 66, 67] },
            { id: 65, type: 'subtopic', parent: 64, name: 'ER model & Relational model', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 66, type: 'subtopic', parent: 64, name: 'SQL & Normalization', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 67, type: 'subtopic', parent: 64, name: 'Transactions & Concurrency Control', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 68, type: 'topic', name: 'Computer Networks', parent: 35, children: [69, 70, 71] },
            { id: 69, type: 'subtopic', parent: 68, name: 'TCP/IP Protocol Stack', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 70, type: 'subtopic', parent: 68, name: 'Routing protocols', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 71, type: 'subtopic', parent: 68, name: 'Network security', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 72, type: 'subject', name: 'Data Science and Artificial Intelligence (DA)', children: [73, 77, 81, 85, 89, 93] },
            { id: 73, type: 'topic', name: 'Probability and Statistics', parent: 72, children: [74, 75, 76] },
            { id: 74, type: 'subtopic', parent: 73, name: 'Descriptive & Inferential Statistics', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 75, type: 'subtopic', parent: 73, name: 'Probability Distributions', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 76, type: 'subtopic', parent: 73, name: 'Sampling, Regression & Correlation', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 77, type: 'topic', name: 'Linear Algebra', parent: 72, children: [78, 79, 80] },
            { id: 78, type: 'subtopic', parent: 77, name: 'Vectors, Matrices & Determinants', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 79, type: 'subtopic', parent: 77, name: 'Vector spaces & Eigenvalues', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 80, type: 'subtopic', parent: 77, name: 'Linear Transformations', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 81, type: 'topic', name: 'Calculus and Optimization', parent: 72, children: [82, 83, 84] },
            { id: 82, type: 'subtopic', parent: 81, name: 'Limits, Continuity & Differentiability', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 83, type: 'subtopic', parent: 81, name: 'Integral Calculus', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 84, type: 'subtopic', parent: 81, name: 'Optimization', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 85, type: 'topic', name: 'Programming, Data Structures and Algorithms', parent: 72, children: [86, 87, 88] },
            { id: 86, type: 'subtopic', parent: 85, name: 'Python, NumPy & Pandas', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 87, type: 'subtopic', parent: 85, name: 'Data structures (Stacks, Queues, Trees)', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 88, type: 'subtopic', parent: 85, name: 'Algorithms (Sorting, Searching)', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 89, type: 'topic', name: 'Database Management & Data Warehousing', parent: 72, children: [90, 91, 92] },
            { id: 90, type: 'subtopic', parent: 89, name: 'Relational model & SQL queries', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 91, type: 'subtopic', parent: 89, name: 'Normalization & Joins', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 92, type: 'subtopic', parent: 89, name: 'Data warehousing & ETL', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 93, type: 'topic', name: 'Machine Learning', parent: 72, children: [94, 95, 96] },
            { id: 94, type: 'subtopic', parent: 93, name: 'Supervised & Unsupervised Learning', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 95, type: 'subtopic', parent: 93, name: 'Regression, Classification & Ensemble Methods', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
            { id: 96, type: 'subtopic', parent: 93, name: 'Overfitting, Cross-validation & Regularization', status: 'Not Started', completionDate: '', revisions: 0, pyqs: '', mocks: '', notes: '', dpp1: '', dpp2: '' },
        ];


        document.addEventListener('DOMContentLoaded', () => {
            setLogLevel('debug');
            initializeFirebase();
            setupChart();
            setupEventListeners();
        });

        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // This is the key part that waits for the user ID.
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        // Listen for real-time changes to the tracker data
                        listenForTrackerData(userId);
                    } else {
                         console.log("Authentication state changed to signed out.");
                         isLoading = false;
                         renderTrackerList(); // Render empty list or a message
                    }
                });

            } catch (error) {
                console.error("Firebase initialization or authentication failed:", error);
                isLoading = false;
                renderTrackerList();
            }
        }
        
        function listenForTrackerData(currentUserId) {
            const dataDocRef = doc(db, `/artifacts/${appId}/users/${currentUserId}/data/tracker_data`);
            
            // Set up real-time listener
            onSnapshot(dataDocRef, (docSnap) => {
                isLoading = false;
                if (docSnap.exists() && docSnap.data().data) {
                    try {
                        // Deserialize the data
                        trackerData = JSON.parse(docSnap.data().data);
                        console.log("Tracker data loaded from Firestore.");
                    } catch (e) {
                        console.error("Error parsing tracker data:", e);
                        trackerData = []; // Reset to empty on parse error
                    }
                    renderTrackerList();
                    updateSummary();
                } else {
                    console.log("No existing data found, initializing with default data.");
                    initializeDefaultData();
                    // We call renderTrackerList() here so it's not empty while data is written.
                    renderTrackerList(); 
                }
            }, (error) => {
                console.error("Error listening to Firestore document:", error);
                isLoading = false;
                renderTrackerList();
            });
        }
        
        async function updateDataInFirestore() {
            if (!userId) {
                console.warn("User not authenticated, cannot save data.");
                return;
            }
            try {
                const dataDocRef = doc(db, `/artifacts/${appId}/users/${userId}/data/tracker_data`);
                // Serialize the data before saving
                const dataToSave = JSON.stringify(trackerData);
                await setDoc(dataDocRef, { data: dataToSave, lastUpdated: Date.now() });
                console.log("Tracker data saved to Firestore.");
            } catch (e) {
                console.error("Error writing document to Firestore:", e);
            }
        }
        
        function initializeDefaultData() {
            trackerData = defaultSyllabusData;
            updateDataInFirestore();
        }
        
        function setupEventListeners() {
            const trackerList = document.getElementById('tracker-list');
            trackerList.addEventListener('change', (e) => {
                if (e.target.classList.contains('status-select')) {
                    const id = parseInt(e.target.dataset.id);
                    const item = trackerData.find(i => i.id === id);
                    item.status = e.target.value;
                    if(e.target.value === 'Completed' && !item.completionDate) {
                        item.completionDate = new Date().toISOString().split('T')[0];
                        renderTrackerList();
                    }
                    updateParentStatus(item.parent);
                    updateDataInFirestore();
                } else if(e.target.classList.contains('date-input')) {
                    const id = parseInt(e.target.dataset.id);
                    trackerData.find(i => i.id === id).completionDate = e.target.value;
                    updateDataInFirestore();
                }
            });

            trackerList.addEventListener('input', (e) => {
                if (e.target.classList.contains('notes-input') || e.target.classList.contains('pyqs-input') || e.target.classList.contains('mocks-input') || e.target.classList.contains('dpp1-input') || e.target.classList.contains('dpp2-input')) {
                    const id = parseInt(e.target.dataset.id);
                    const key = e.target.dataset.key;
                    trackerData.find(i => i.id === id)[key] = e.target.value;
                    // Debounce this to avoid too many writes
                    clearTimeout(e.target.dataset.timeout);
                    e.target.dataset.timeout = setTimeout(() => {
                        updateDataInFirestore();
                    }, 1000);
                }
            });

            trackerList.addEventListener('click', (e) => {
                const button = e.target.closest('.revision-btn');
                if (button) {
                    const id = parseInt(button.dataset.id);
                    const action = button.dataset.action;
                    const item = trackerData.find(i => i.id === id);
                    if (action === 'increase') {
                        item.revisions++;
                    } else if (action === 'decrease' && item.revisions > 0) {
                        item.revisions--;
                    }
                    document.querySelector(`.revision-count[data-id="${id}"]`).textContent = item.revisions;
                    updateDataInFirestore();
                } else if (e.target.closest('.subject-header, .topic-header')) {
                     const header = e.target.closest('.subject-header, .topic-header');
                     const contentId = header.dataset.controls;
                     document.getElementById(contentId).classList.toggle('hidden');
                     header.querySelector('.toggle-icon').classList.toggle('rotate-90');
                }
            });

            document.getElementById('filter-buttons').addEventListener('click', (e) => {
                if(e.target.tagName === 'BUTTON') {
                    currentFilter = e.target.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-amber-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'text-gray-700');
                    });
                    e.target.classList.add('active', 'bg-amber-600', 'text-white');
                    e.target.classList.remove('bg-gray-200', 'text-gray-700');
                    renderTrackerList();
                }
            });
        }
        
        function getSubtopicProgress(childrenIds) {
            const subtopics = childrenIds.map(id => trackerData.find(i => i.id === id))
                                        .flatMap(item => item && item.type === 'subtopic' ? [item] : (item && item.children ? getSubtopicProgress(item.children) : []));
            const total = subtopics.length;
            if (total === 0) return { mastered: 0, total: 0 };
            const mastered = subtopics.filter(s => s.status === 'Mastered').length;
            return { mastered, total };
        }


        function renderTrackerList() {
            const listContainer = document.getElementById('tracker-list');
            if (isLoading) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg">
                        <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-amber-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-lg text-gray-600 font-medium">Loading your tracker data...</p>
                    </div>`;
                return;
            }
            if (trackerData.length === 0) {
                 listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8 bg-gray-50 rounded-lg">
                        <p class="mt-4 text-lg text-gray-600 font-medium">No data found. Please check your user ID or contact support.</p>
                    </div>`;
                return;
            }

            let html = '';
            
            const subjects = trackerData.filter(item => item.type === 'subject');

            subjects.forEach(subject => {
                 if (currentFilter !== 'All' && subject.name !== currentFilter) {
                    return;
                }
                const { mastered, total } = getSubtopicProgress(subject.children);
                const progress = total > 0 ? Math.round((mastered / total) * 100) : 0;


                html += `
                    <div class="bg-gray-50 rounded-lg border border-gray-200">
                        <div class="subject-header p-4 flex justify-between items-center" data-controls="content-${subject.id}">
                            <div class="flex items-center gap-4">
                               <span class="toggle-icon transition-transform transform">&#9654;</span>
                                <h3 class="font-bold text-lg text-gray-700">${subject.name}</h3>
                            </div>
                            <div class="flex items-center gap-3 text-sm">
                                <span>${mastered}/${total} Mastered</span>
                                <div class="w-24 bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-amber-500 h-2.5 rounded-full" style="width: ${progress}%"></div>
                                </div>
                            </div>
                        </div>
                        <div id="content-${subject.id}" class="hidden px-4 pb-2">`;
                
                subject.children.forEach(topicId => {
                    const topic = trackerData.find(item => item.id === topicId);
                    if (!topic) return;
                    const { mastered: topicMastered, total: topicTotal } = getSubtopicProgress(topic.children);
                    const topicProgress = topicTotal > 0 ? Math.round((topicMastered / topicTotal) * 100) : 0;
                    
                    html += `
                        <div class="ml-4 my-2 border-l-2 border-gray-300">
                             <div class="topic-header pl-4 py-2 flex justify-between items-center" data-controls="content-${topic.id}">
                                <div class="flex items-center gap-3">
                                   <span class="toggle-icon transition-transform transform">&#9654;</span>
                                   <h4 class="font-semibold text-md text-gray-600">${topic.name}</h4>
                                </div>
                                <div class="flex items-center gap-3 text-xs">
                                    <span>${topicMastered}/${topicTotal}</span>
                                     <div class="w-20 bg-gray-200 rounded-full h-2">
                                        <div class="bg-amber-500 h-2 rounded-full" style="width: ${topicProgress}%"></div>
                                    </div>
                                </div>
                            </div>
                            <div id="content-${topic.id}" class="hidden pl-8 pb-2">
                                <div class="space-y-4 pt-2">`;

                    topic.children.forEach(subtopicId => {
                        const subtopic = trackerData.find(item => item.id === subtopicId);
                        if (!subtopic) return;
                        html += createSubtopicHTML(subtopic);
                    });

                    html += `</div></div></div>`;
                });

                html += `</div></div>`;
            });

            listContainer.innerHTML = html;
        }

        function createSubtopicHTML(subtopic) {
            // Defensive check to prevent crash if status is missing
            const statusColor = (subtopic.status && statusConfig[subtopic.status]) ? statusConfig[subtopic.status].color : 'bg-gray-400';
            const currentStatus = subtopic.status || 'Not Started';

            return `
                <div class="p-4 bg-white rounded-md border border-gray-200 shadow-sm">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                             <div class="status-dot ${statusColor}"></div>
                            <span class="font-medium text-gray-800">${subtopic.name}</span>
                        </div>
                        <select data-id="${subtopic.id}" class="status-select text-xs p-1 rounded border-gray-300">
                            ${Object.keys(statusConfig).map(s => `<option value="${s}" ${currentStatus === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 text-sm">
                        <div>
                            <label class="block font-semibold text-gray-500 text-xs">Completion Date</label>
                            <input type="date" data-id="${subtopic.id}" value="${subtopic.completionDate}" class="date-input mt-1 w-full p-1 border rounded-md border-gray-300 text-xs">
                        </div>
                        <div>
                            <label class="block font-semibold text-gray-500 text-xs">Revisions</label>
                            <div class="flex items-center mt-1">
                                <button data-id="${subtopic.id}" data-action="decrease" class="revision-btn px-2 border rounded-l-md bg-gray-100">-</button>
                                <span data-id="${subtopic.id}" class="revision-count px-3 border-t border-b">${subtopic.revisions}</span>
                                <button data-id="${subtopic.id}" data-action="increase" class="revision-btn px-2 border rounded-r-md bg-gray-100">+</button>
                            </div>
                        </div>
                        <div>
                            <label class="block font-semibold text-gray-500 text-xs">DPP 1 (Basic)</label>
                            <input type="text" data-id="${subtopic.id}" data-key="dpp1" value="${subtopic.dpp1}" placeholder="e.g. 15/20" class="dpp1-input mt-1 w-full p-1 border rounded-md border-gray-300 text-xs">
                        </div>
                        <div>
                            <label class="block font-semibold text-gray-500 text-xs">DPP 2 (Advanced)</label>
                            <input type="text" data-id="${subtopic.id}" data-key="dpp2" value="${subtopic.dpp2}" placeholder="e.g. 10/15" class="dpp2-input mt-1 w-full p-1 border rounded-md border-gray-300 text-xs">
                        </div>
                        <div>
                            <label class="block font-semibold text-gray-500 text-xs">PYQ's</label>
                            <input type="text" data-id="${subtopic.id}" data-key="pyqs" value="${subtopic.pyqs}" placeholder="e.g. 20/25" class="pyqs-input mt-1 w-full p-1 border rounded-md border-gray-300 text-xs">
                        </div>
                         <div>
                            <label class="block font-semibold text-gray-500 text-xs">Mock Tests</label>
                            <input type="text" data-id="${subtopic.id}" data-key="mocks" value="${subtopic.mocks}" placeholder="e.g. 85%" class="mocks-input mt-1 w-full p-1 border rounded-md border-gray-300 text-xs">
                        </div>
                        <div class="col-span-2 md:col-span-4 lg:col-span-1">
                            <label class="block font-semibold text-gray-500 text-xs">Notes</label>
                            <textarea data-id="${subtopic.id}" data-key="notes" placeholder="Key formulas, weak areas..." class="notes-input mt-1 w-full p-1 border rounded-md border-gray-300 text-xs h-12 resize-none">${subtopic.notes}</textarea>
                        </div>
                    </div>
                </div>`;
        }
        
        function updateParentStatus(parentId) {
            if (!parentId) return;

            const parent = trackerData.find(i => i.id === parentId);
            if (!parent) return;
            const children = parent.children.map(id => trackerData.find(i => i.id === id));
            
            const allMastered = children.every(child => child && child.status === 'Mastered');
            const someInProgress = children.some(child => child && child.status !== 'Not Started');
            
            let newStatus;
            if (allMastered) {
                newStatus = 'Mastered';
            } else if (someInProgress) {
                newStatus = 'In Progress';
            } else {
                newStatus = 'Not Started';
            }
            
            if (parent.status !== newStatus) {
                parent.status = newStatus;
                if (parent.parent) {
                    updateParentStatus(parent.parent);
                }
            }
        }

        function updateSummary() {
            const subtopics = trackerData.filter(i => i.type === 'subtopic');
            const counts = {
                "Mastered": 0,
                "In Progress": 0,
                "Completed": 0,
                "Revised": 0,
                "Not Started": 0
            };
            if (subtopics.length > 0) {
                 subtopics.forEach(s => {
                    counts[s.status]++;
                });
            } else {
                counts['Not Started'] = defaultSyllabusData.filter(i => i.type === 'subtopic').length;
            }

            document.getElementById('mastered-count').textContent = counts['Mastered'];
            document.getElementById('in-progress-count').textContent = counts['In Progress'];
            document.getElementById('completed-count').textContent = counts['Completed'] + counts['Revised'] + counts['Mastered'];
            document.getElementById('not-started-count').textContent = counts['Not Started'];
            
            const chartData = [
                counts['Not Started'],
                counts['In Progress'],
                counts['Completed'],
                counts['Revised'],
                counts['Mastered']
            ];

            progressChart.data.datasets[0].data = chartData;
            progressChart.update();
        }

        function setupChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            progressChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Not Started', 'In Progress', 'Completed', 'Revised', 'Mastered'],
                    datasets: [{
                        label: 'Topics',
                        data: [1, 1, 1, 1, 1],
                        backgroundColor: [
                            '#9CA3AF', // Gray
                            '#3B82F6', // Blue
                            '#6366F1', // Indigo
                            '#A855F7', // Purple
                            '#22C55E'  // Green
                        ],
                        borderColor: '#FDFBF8',
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20,
                                boxWidth: 12,
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed + ' topics';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            background-color: #FDFBF8;
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d4c4b3;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #bca994;
        }
        .subject-header, .topic-header {
            cursor: pointer;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">GATE 2026 Interactive Preparation Tracker</h1>
            <p class="text-gray-500 mt-2">A dashboard to visualize and manage your CSE & DA exam preparation.</p>
        </header>

        <div class="text-center text-sm mb-4 text-gray-600 font-medium">
            Your unique User ID: <span id="user-id-display" class="font-semibold text-gray-800 break-all">Loading...</span>
        </div>

        <main>
            <!-- Summary Section -->
            <section id="summary" class="mb-8 p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-700 mb-6 text-center">Preparation Overview</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-center">
                    <div class="lg:col-span-1">
                        <div class="grid grid-cols-2 sm:grid-cols-1 gap-4">
                             <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-600">Mastered</h3>
                                <p id="mastered-count" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-600">In Progress</h3>
                                <p id="in-progress-count" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                             <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-600">Completed</h3>
                                <p id="completed-count" class="text-3xl font-bold text-indigo-600">0</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg text-center border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-600">Not Started</h3>
                                <p id="not-started-count" class="text-3xl font-bold text-gray-500">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-1 lg:col-span-3">
                        <div class="chart-container">
                            <canvas id="progressChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Filters and Tracker Section -->
            <section id="tracker" class="p-6 bg-white rounded-2xl shadow-sm border border-gray-200">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4 sm:mb-0">Syllabus Tracker</h2>
                    <div id="filter-buttons" class="flex flex-wrap gap-2">
                        <button class="filter-btn active bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium" data-filter="All">All</button>
                        <button class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium" data-filter="General Aptitude">General Aptitude</button>
                        <button class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium" data-filter="Computer Science and Information Technology (CS)">CS & IT</button>
                        <button class="filter-btn bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium" data-filter="Data Science and Artificial Intelligence (DA)">DA & AI</button>
                    </div>
                </div>
                <div id="tracker-list" class="space-y-3">
                    <!-- JS will populate this -->
                </div>
            </section>
        </main>
    </div>
</body>
</html>



